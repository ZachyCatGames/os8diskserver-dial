   1               /       SDSKSY OS/8 SYSTEM HANDLER
   2               
   3               /       SERIAL INTERFACE-BASED DISK SYSTEM DEVICE HANDLER [USE WITH PC SERVER].
   4               
   5               /       LAST EDIT: 06-AUG-2016 CJL
   6               
   7               /       EDIT HISTORY.
   8               
   9               /       06-AUG-2016     CHARLES LASNER  CODE CLEANUP.
  10               
  11               /       NOTABLE CHANGES.
  12               
  13               /       1) ADDS THIS EDIT HISTORY.
  14               
  15               /       2) REMOVES MINOR INCOMPATIBLE SOURCE CODE QUIRKS.  [NOTE: ALL CHANGES MADE
  16               /          ARE COSMETIC, BUT TECHNICALLY VIOLATE THE PAL LANGUAGE SPECIFICATION.  OS/8
  17               /          PAL8 IS DEFICIENT AT FLAGGING CERTAIN ERRORS THAT WILL BE PROPERLY DETECTED
  18               /          BY OTHER ASSEMBLY PROGRAMS SUCH AS PAL III, P?S/8 PAL, THE LAP6-DIAL/DIAL-MS
  19               /          ASSEMBLER AND TOPS1O PAL10.]
  20               
  21               /       3) REMOVES INCOMPATIBILITY WITH LANGUAGE EXTENSIONS FOUND IN OTHER ASSEMBLERS
  22               /          [SUCH AS THE ERROR DIRECTIVE].
  23               
  24               /       4) REMOVAL OF CONTROL-C DETECTION.  THIS IS A DESIGN FLAW: WHEN CONTROL-C IS
  25               /          DETECTED, THE KEYBOARD INPUT FLAG IS LEFT SET [WHICH IS THE PROPER ACTION
  26               /          PER SE].  THE SYSTEM HANDLER WILL BE IMMEDIATELY ENTERED AT 07600 WITH A
  27               /          CALL TO WRITE OUT A PORTION OF MEMORY TO THE SYSTEM SCRATCH BLOCKS; WHILE
  28               /          THE KEYBOARD FLAG IS NOT CHECKED DURING THE WRITE OPERATION, THE FLAG IS
  29               /          STILL SET.  THE NEXT INTERNAL CALL TO THE SYSTEM DEVICE HANDLER IS AN
  30               /          ATTEMPT TO RELOAD THE KEYBOARD MONITOR [WHICH WOULD DISPOSE OF THE KEYBOARD
  31               /          FLAG BY VARIOUS APPROPRIATE MEANS AFTER CLEARING THE FLAG]; HOWEVER, SINCE
  32               /          THIS LATEST CALL IS A READ OPERATION, THE KEYBOARD FLAG IS DETECTED CAUSING
  33               /          ANOTHER REBOOT TO 07600.  THUS, THE KEYBOARD FLAG IS NEVER CLEARED AS THE
  34               /          CODE THAT IS DESIGNED TO HANDLE IT NEVER GAINS CONTROL; THIS RESULTS IN AN
  35               /          INFINITE LOOP SITUATION.  [NOTE: NO OFFICIAL DEC OS/8 SYSTEM HANDLERS CHECK
  36               /          FOR CONTROL-C; THIS FUNCTION IS AN OPTION FOR NON-SYSTEM HANDLERS ONLY.]
  37               
  38               /       5) DEVICE GROUP NAMES MODIFIED FOR CONSISTENCY WITH THE NON-SYSTEM HANDLERS.
  39               
  40               /       6) MAJOR SOURCE CODE CLEANUP DEFERRED PENDING TESTING OF THE PROGRAM.  [NOTE:
  41               /          AMONG OTHER PROBLEMS, THE SOURCE CODE APPEARS TO BE A RECOVERY FROM A
  42               /          LISTING FILE AND DOES NOT CONFORM TO PDP-8 SOURCE CODE STANDARDS; OTHER THAN
  43               /          MORE RECENT MINOR EDITS, THERE ARE NO HORIZONTAL TAB CHARACTERS.]
  44               
  45               /       7) RELEASE UPDATED TO VERSION F.
  46               
  47               /       16-NOV-2015     BOB ADAMSON     FIRST MAJOR UPDATE.
  48               
  49               /       NOTE: THIS RELEASE DATE IS APPROXIMATE.  IT IS MORE LIKELY AN EARLY DATE IN A
  50               /       PERIOD THAT SPANS SEVERAL MONTHS.
  51               
  52               /       NOTABLE CHANGES:
  53               
  54               /       1) REMOVES REDUNDANT CDF INSTRUCTIONS TO SHORTEN THE CODE.
  55               
  56               /       2) REPLACES BSW INSTRUCTIONS WITH THREE ROTATE INSTRUCTIONS EACH TO MAINTAIN
  57               /          COMPATIBILITY WITH ALL "FAMILY OF 8" MACHINES INSTEAD OF OMNIBUS AND NEWER.
  58               
  59               /       3) DISABLES INTERRUPTS FROM WITHIN THE HANDLER.
  60               
  61               /       4) ADDS CONTROL-C CHECKING TO ABORT TO OS/8 KEYBOARD MONITOR.
  62               
  63               /       5) LIMITS CONTROL-C CHECKING TO READ OPERATIONS ONLY TO PREVENT THE SERVER
  64               /          FROM HANGING.
  65               
  66               /       6) RELEASE UPDATED TO VERSION E.
  67               
  68               /       17-FEB-2014     KYLE OWEN       INITIAL RELEASE AND UPDATES.
  69               
  70               /       NOTABLE FEATURES:
  71               
  72               /       1) RUNS ON OMNIBUS MACHINES ONLY.
  73               
  74               /       2) HANDLER RELEASED AT VERSION D.
  75               
  76               /       3) INCLUDES CO-RESIDENT HANDLER FOR SDB0:.
  77               
  78               /       4) INCLUDES CO-RESIDENT HANDLER DUMMY FOR SDA0: [SAME AS SYS].
  79               
  80               /       NOTE: AS ALSO APPLIES TO THE OS/8 RK8E SYSTEM HANDLER, THE CO-RESIDENT ENTRY
  81               /       POINTS ONLY FUNCTION AS DESCRIBED IF THE SYSTEM IS BOOTED TO DRIVE UNIT 0.
  82               /       PRESENTLY, THIS RESTRICTION IS SUPERFLUOUS TO THE SERIAL DISK SYSTEM HANDLER
  83               /       AS NO EXTENDED DISK BOOTUP IS CURRENTLY SUPPORTED; HOWEVER, THE RESTRICTIONS
  84               /       SHOULD BE DOCUMENTED SHOULD FUTURE RELEASES SUPPORT ADDITIONAL BOOTUP DRIVES.
  85               
  86               VERS="F&77
  87               
  88               BASER=6400                      /USING DEVICE CODES 40,41
  89               BASET=6410
  90               
  91               SKCF=BASER
  92               SKSF=BASER+1
  93               SKCC=BASER+2
  94               SKRS=BASER+4
  95               SKIE=BASER+5
  96               SKRB=BASER+6
  97               
  98               STFL=BASET
  99               STSF=BASET+1
 100               STCF=BASET+2
 101               STPC=BASET+4
 102               STSK=BASET+5
 103               STLS=BASET+6
 104               
 105               BLKNUM=6260
 106               
 107               /       HANDLER SENDS:
 108               
 109               /       A OR B -        COMMAND SERVER, SIDE 0 OR 1
 110               /       <ATSIGN> -      SEND BOOT CODE
 111               
 112                       *0
 113               
 114 000000  7775          -3              /THREE DEVICES (SYSTEM PLUS 2 LOGICAL DISKS)
 115               
 116 000001  2304          DEVICE SDSY; DEVICE SYS ; 4640; ENTRY1&177+2000; 0; BLKNUM
     000002  2331  
     000003  2331  
     000004  2300  
     000005  4640  
     000006  2007  
     000007  0000  
     000010  6260  
 117 000011  2304          DEVICE SDSY; DEVICE SDA0; 4640; ENTRY1&177+1000; 0; BLKNUM
     000012  2331  
     000013  2304  
     000014  0160  
     000015  4640  
     000016  1007  
     000017  0000  
     000020  6260  
 118 000021  2304          DEVICE SDSY; DEVICE SDB0; 4640; ENTRY2&177+1000; 0; BLKNUM
     000022  2331  
     000023  2304  
     000024  0260  
     000025  4640  
     000026  1066  
     000027  0000  
     000030  6260  
 119               
 120 000031  7732          BOOT-ENDB               /BOOT CODE LENGTH [NEGATED].
 121               
 122                       RELOC 0
 123               
 124 000000* 7200  BOOT,   CLA                     /CLEAN UP NOW.
 125 000001* 1413          TAD I BOOTX1    /COPY FROM 00200-00400 TO 07600-00000
 126 000002* 3414          DCA I BOOTX2
 127 000003* 1415          TAD I BOOTX3    /COPY FROM 00047-00247 TO 17647-10047
 128 000004* 6211          CDF 10
 129 000005* 3416          DCA I BOOTX4
 130 000006* 6201          CDF 0
 131 000007* 1014          TAD BOOTX2
 132 000010* 7640          SZA CLA         /DONE?
 133 000011* 5001          JMP BOOT+1              /NO, KEEP COPYING
 134 000012* 5444          JMP I   B7605/(SBOOT+5) /JUMP TO OS/8
 135               
 136 000013* 0177  BOOTX1, 177
 137 000014* 7577  BOOTX2, 7577
 138 000015* 0046  BOOTX3, 46
 139 000016* 7646  BOOTX4, 7646
 140 000017* 0017  ADDR,   17
 141                       ZBLOCK 20-.
 142 000020* 7240          CLA CMA         /AC=7777
 143 000021* 3017          DCA ADDR        /SET UP ADDRESS
 144 000022* 1045          TAD BOOTMS      /SEND BOOT MESSAGE TO SERVER
 145 000023* 6416          STLS
 146 000024* 6411          STSF
 147 000025* 5024          JMP .-1
 148 000026* 6402  RDLP,   SKCC            /CLEAR AC AND FLAG
 149 000027* 6401          SKSF            /SKIP IF FLAG SET
 150 000030* 5027          JMP .-1
 151 000031* 6406          SKRB            /READ BUFFER
 152 000032* 7106          CLL RTL         /ROTATE 6 LEFT
 153 000033* 7006          RTL
 154 000034* 7510          SPA             /CHANNEL 8 PUNCHED?
 155 000035* 5000          JMP BOOT        /YES, CONTINUE BOOTING
 156 000036* 7006          RTL
 157 000037* 6401          SKSF            /SKIP IF FLAG SET
 158 000040* 5037          JMP .-1
 159 000041* 6404          SKRS            /OR BUFFER WITH AC
 160 000042* 3417          DCA I ADDR      /STORE CONTENTS
 161 000043* 5026          JMP RDLP        /KEEP LOOPING
 162               
 163 000044* 7605  B7605,  7605            /ADDRESS OF OS/8 ENTRY
 164 000045* 0100  BOOTMS, 100             /<AT-SIGN> COMMAND TO SERVER
 165               ENDB,   RELOC
 166               
 167                       *200
 168                       RELOC 7600
 169 007600* 0000          ZBLOCK 7
     007601* 0000  
     007602* 0000  
     007603* 0000  
     007604* 0000  
     007605* 0000  
     007606* 0000  
 170 007607* 0006  ENTRY1, VERS
 171 007610* 7300          CLA CLL         /CLEAR LINK FOR FIRST PLATTER
 172 007611* 1342  SETUP,  TAD WKUP        /ADD WAKEUP CHARACTER
 173 007612* 4274          JMS SENDC       /SEND WAKEUP CHARACTER
 174 007613* 7200          CLA
 175 007614* 6405          SKIE            /NO INTERRUPTS FROM THIS CONSOLE
 176 007615* 6214          RDF             /GET CURRENT FIELD
 177 007616* 1261          TAD SCDI        /ADD CDI
 178 007617* 3335          DCA SFIELD      /DEPOSIT MODIFIED CIF
 179 007620* 1607          TAD I ENTRY1    /GET FUNCTION
 180 007621* 4301          JMS SNDNUM      /TELL SERVER FUNCTION
 181 007622* 2207          ISZ ENTRY1      /LOOK AT BUFFER ADDRESS
 182 007623* 1607          TAD I ENTRY1    /GET BUFFER ADDRESS
 183 007624* 4301          JMS SNDNUM      /TELL SERVER BUFFER ADDRESS
 184 007625* 1607          TAD I ENTRY1    /GET BUFFER ADDRESS
 185 007626* 3266          DCA SLOC        /STORE BUFFER ADDRESS
 186 007627* 2207          ISZ ENTRY1      /LOOK AT STARTING BLOCK NUMBER
 187 007630* 1607          TAD I ENTRY1    /GET STARTING BLOCK NUMBER
 188 007631* 4301          JMS SNDNUM      /TELL SERVER STARTING BLOCK NUMBER
 189 007632* 2207          ISZ ENTRY1      /LOOK AT ERROR RETURN
 190 007633* 4311          JMS GETNUM      /RECEIVE CDF INSTRUCTION
 191 007634* 3235          DCA .+1         /SAVE AND THEN EXECUTE THE CDF
 192 007635* 7402          HLT             /BECOMES CDF TO XFER FIELD
 193 007636* 4311          JMS GETNUM      /RECEIVE NEGATIVE WORD COUNT
 194 007637* 3341          DCA WORDCT
 195 007640* 4311  GETACK, JMS GETNUM      /4000=READ, 4001=WRITE, 0000=DONE, 2000=ERROR
 196 007641* 7450          SNA             /WAS IT ZERO?
 197 007642* 5334          JMP EXIT        /YES, EXIT
 198 007643* 7104          CLL RAL         /NO, IS HIGH BIT SET?
 199 007644* 7420          SNL
 200 007645* 5337          JMP SYSERR       /NO, ERROR!
 201 007646* 7640          SZA CLA         /YES, READ OR WRITE?
 202 007647* 5325          JMP TXLP        /TIME TO WRITE
 203               
 204 007650* 4311  RXLP,   JMS GETNUM      /GET WORD
 205 007651* 3666          DCA I SLOC      /STORE CONTENTS
 206 007652* 2266          ISZ SLOC        /NEXT LOCATION
 207 007653* 6031          KSF             /WE WILL CHECK FOR A ^C
 208 007654* 5263          JMP RXLP1       /NO KEY PRESSED (OR ISZ SKIPPED HERE)
 209 007655* 6034          KRS             /IF HE'S TYPED READ THE KEY
 210 007656* 1343          TAD M203        /^C IS (USUALLY) CODE 203
 211 007657* 7200          CLA/SZA CLA         /WAS IT?
 212 007660* 5263          JMP RXLP1       /WASN'T A ^C
 213 007661* 6203  SCDI,   CIF CDF 0
 214 007662* 5707          JMP I S7600
 215 007663* 2341  RXLP1,  ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 216 007664* 5250          JMP RXLP        /NO, KEEP LOOPING
 217 007665* 5240          JMP GETACK      /ANY OTHER REQUESTS?
 218               
 219               SLOC,                   /REUSE THIS LOCATION
 220 007666* 0006  ENTRY2, VERS            /SECOND ENTRY POINT
 221 007667* 7200          CLA
 222 007670* 1266          TAD ENTRY2      /GET ARGUMENT ADDRESS
 223 007671* 3207          DCA ENTRY1      /STORE IT IN COMMON PLACE
 224 007672* 7301          CLA CLL IAC     /SET AC = 1 FOR 2ND PLATTER
 225 007673* 5211          JMP SETUP       /CONTINUE WITH SETUP
 226               
 227 007674* 0000  SENDC,  0               /SEND CHARACTER IN AC
 228 007675* 6416          STLS
 229 007676* 6411          STSF
 230 007677* 5276          JMP .-1
 231 007700* 5674          JMP I SENDC
 232                       
 233 007701* 0000  SNDNUM, 0               /SEND NUMBER AS TWO CONSECUTIVE CHARACTERS
 234 007702* 4274          JMS SENDC       /SEND BOTTOM 8 BITS OF WORD
 235 007703* 7012          RTR             /NO BSW HERE TO SUIT 8/I ETC
 236 007704* 7012          RTR             /SHIFT TOP BITS DOWN 6
 237 007705* 7012          RTR
 238 007706* 4274          JMS SENDC       /SEND TOP 4 BITS PLUS SOME - LET SERVER HANDLE IT
 239 007707* 7600  S7600,  7600            /=CLA, ALSO OS/8 ENTRY POINT
 240 007710* 5701          JMP I SNDNUM
 241               
 242 007711* 0000  GETNUM, 0
 243 007712* 6402          SKCC            /CLEAR AC AND FLAG
 244 007713* 6401          SKSF            /SKIP IF FLAG SET
 245 007714* 5313          JMP .-1
 246 007715* 6406          SKRB            /READ BUFFER WHICH IS FIRST SIXBIT
 247 007716* 7106          CLL RTL         /SHIFT SIXBIT TO BITS 0-5
 248 007717* 7006          RTL             /NO BSW TO SUIT 8/I ETC
 249 007720* 7006          RTL
 250 007721* 6401          SKSF            /SKIP IF FLAG SET
 251 007722* 5321          JMP .-1         /WHICH WILL BE THE 2ND SIXBIT
 252 007723* 6404          SKRS            /OR WITH AC TO GIVE 12 BIT WORD
 253 007724* 5711          JMP I GETNUM
 254               
 255 007725* 1666  TXLP,   TAD I SLOC      /GET WORD
 256 007726* 2266          ISZ SLOC        /NEXT LOCATION
 257 007727* 7000          NOP
 258 007730* 4301          JMS SNDNUM      /SEND IT
 259 007731* 2341          ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 260 007732* 5325          JMP TXLP        /NO, KEEP LOOPING
 261 007733* 5240          JMP GETACK      /ANY MORE REQUESTS?
 262               
 263               
 264 007734* 2207  EXIT,   ISZ ENTRY1      /NORMAL EXIT
 265 007735* 7402  SFIELD, HLT             /MODIFIED TO CDI
 266 007736* 5607          JMP I ENTRY1    /EXIT
 267 007737* 7130  SYSERR, CLL CML RAR     /ROTATE ERROR CODE AND SET NEGATIVE BIT
 268 007740* 5335          JMP SFIELD      /ERROR EXIT
 269                       
 270 007741* 0000  WORDCT, 0
 271 007742* 0101  WKUP,   101
 272 007743* 7575  M203,   -203            /^C IS CODE 203
 273                       ZBLOCK 7744-.
 274                       RELOC
 275               $

ADDR    0017
B7605   0044
BASER   6400
BASET   6410
BLKNUM  6260
BOOT    0000
BOOTMS  0045
BOOTX1  0013
BOOTX2  0014
BOOTX3  0015
BOOTX4  0016
ENDB    0046
ENTRY1  7607
ENTRY2  7666
EXIT    7734
GETACK  7640
GETNUM  7711
M203    7743
RDLP    0026
RXLP    7650
RXLP1   7663
S7600   7707
SCDI    7661
SENDC   7674
SETUP   7611
SFIELD  7735
SKCC    6402
SKCF    6400 unreferenced
SKIE    6405
SKRB    6406
SKRS    6404
SKSF    6401
SLOC    7666
SNDNUM  7701
STCF    6412 unreferenced
STFL    6410 unreferenced
STLS    6416
STPC    6414 unreferenced
STSF    6411
STSK    6415 unreferenced
SYSERR  7737
TXLP    7725
VERS    0006
WKUP    7742
WORDCT  7741
