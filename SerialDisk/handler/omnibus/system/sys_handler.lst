   1               /SERIAL-BASED DISK SYSTEM - SYS
   2               /SYSTEM HANDLER FOR OS/8 FOR OMNIBUS AND PRE-OMNIBUS
   3               
   4               /KYLE OWEN      17/FEB/2014     - ORIGINAL TO VERSION D
   5               /BOB ADAMSON    16/NOV/2015     - REMOVED REDUNDANT CDFS
   6               /                               - REPLACED BSWS WITH ROTATES
   7               /                               - DISABLED INTERRUPTS FROM HERE
   8               /                               - NO CHECK ON WRITE BECAUSE SERVER WOULD HANG
   9               
  10               VERS="E&77
  11               
  12               BASER=6400                      /USING DEVICE CODES 40,41
  13               BASET=6410
  14               
  15               SKCF=BASER
  16               SKSF=BASER+1
  17               SKCC=BASER+2
  18               SKRS=BASER+4
  19               SKIE=BASER+5
  20               SKRB=BASER+6
  21               
  22               STFL=BASET
  23               STSF=BASET+1
  24               STCF=BASET+2
  25               STPC=BASET+4
  26               STSK=BASET+5
  27               STLS=BASET+6
  28               
  29               BLKNUM=6260
  30               
  31               /HANDLER SENDS:
  32               /A OR B - COMMAND SERVER, SIDE 0 OR 1
  33               /@ - SEND BOOT CODE
  34               
  35                       *0
  36 000000  7775          -3              /THREE DEVICES (SYSTEM PLUS 2 LOGICAL DISKS)
  37 000001  2304          DEVICE SDSK; DEVICE SYS;  4640; ENTRY1&177+2000; 0; BLKNUM
     000002  2313  
     000003  2331  
     000004  2300  
     000005  4640  
     000006  2007  
     000007  0000  
     000010  6260  
  38 000011  2304          DEVICE SDSK; DEVICE SDA0; 4640; ENTRY1&177+1000; 0; BLKNUM
     000012  2313  
     000013  2304  
     000014  0160  
     000015  4640  
     000016  1007  
     000017  0000  
     000020  6260  
  39 000021  2304          DEVICE SDSK; DEVICE SDB0; 4640; ENTRY2&177+1000; 0; BLKNUM
     000022  2313  
     000023  2304  
     000024  0260  
     000025  4640  
     000026  1062  
     000027  0000  
     000030  6260  
  40 000031  7732          BOOT-ENDB
  41               
  42                       RELOC 0
  43               
  44 000000* 7200  BOOT,   CLA
  45 000001* 1413          TAD I BOOTX1    /COPY FROM 00200-00400 TO 07600-00000
  46 000002* 3414          DCA I BOOTX2
  47 000003* 1415          TAD I BOOTX3    /COPY FROM 00047-00247 TO 17647-10047
  48 000004* 6211          CDF 10
  49 000005* 3416          DCA I BOOTX4
  50 000006* 6201          CDF 0
  51 000007* 1014          TAD BOOTX2
  52 000010* 7640          SZA CLA         /DONE?
  53 000011* 5001          JMP BOOT+1      /NO, KEEP COPYING
  54 000012* 5444          JMP I B7605     /JUMP TO OS/8
  55 000013* 0177  BOOTX1, 177
  56 000014* 7577  BOOTX2, 7577
  57 000015* 0046  BOOTX3, 46
  58 000016* 7646  BOOTX4, 7646
  59 000017* 0017  ADDR,   17
  60                       ZBLOCK 20-.
  61 000020* 7240          CLA CMA         /AC=7777
  62 000021* 3017          DCA ADDR        /SET UP ADDRESS
  63 000022* 1045          TAD BOOTMS      /SEND BOOT MESSAGE TO SERVER
  64 000023* 6416          STLS
  65 000024* 6411          STSF
  66 000025* 5024          JMP .-1
  67 000026* 6402  RDLP,   SKCC            /CLEAR AC AND FLAG
  68 000027* 6401          SKSF            /SKIP IF FLAG SET
  69 000030* 5027          JMP .-1
  70 000031* 6406          SKRB            /READ BUFFER
  71 000032* 7106          CLL RTL         /ROTATE 6 LEFT
  72 000033* 7006          RTL
  73 000034* 7510          SPA             /CHANNEL 8 PUNCHED?
  74 000035* 5000          JMP BOOT        /YES, CONTINUE BOOTING
  75 000036* 7006          RTL
  76 000037* 6401          SKSF            /SKIP IF FLAG SET
  77 000040* 5037          JMP .-1
  78 000041* 6404          SKRS            /OR BUFFER WITH AC
  79 000042* 3417          DCA I ADDR      /STORE CONTENTS
  80 000043* 5026          JMP RDLP        /KEEP LOOPING
  81 000044* 7605  B7605,  7605            /ADDRESS OF OS/8 ENTRY
  82 000045* 0100  BOOTMS, 100             /"@" COMMAND TO SERVER
  83               ENDB,   RELOC
  84               
  85                       *200
  86                       RELOC 7600
  87 007600* 0000          ZBLOCK 7
     007601* 0000  
     007602* 0000  
     007603* 0000  
     007604* 0000  
     007605* 0000  
     007606* 0000  
  88 007607* 0005  ENTRY1, VERS
  89 007610* 7300          CLA CLL         /CLEAR AC FOR FIRST PLATTER
  90 007611* 1334  SETUP,  TAD WKUP        /ADD WAKEUP CHARACTER
  91 007612* 3262          DCA SLOC        /SAVE UNTIL WE'VE KILLED INTERRUPTS
  92 007613* 6405          SKIE            /NO INTERRUPTS FROM HERE
  93 007614* 1262          TAD SLOC        /GET THE WAKEUP CODE BACK AGAIN
  94 007615* 4270          JMS SENDC       /SEND WAKEUP CHARACTER
  95 007616* 7200          CLA
  96 007617* 6214          RDF             /GET CURRENT FIELD
  97 007620* 1335          TAD SCDI        /ADD CDI
  98 007621* 3327          DCA SFIELD      /DEPOSIT MODIFIED CIF
  99 007622* 4321          JMS GETNEX      /TELL SERVER REQUIRED FUNCTION
 100 007623* 1607          TAD I ENTRY1    /GET BUFFER ADDRESS
 101 007624* 3262          DCA SLOC        /STORE BUFFER ADDRESS
 102 007625* 4321          JMS GETNEX      /TELL SERVER BUFFER ADDRESS
 103 007626* 4321          JMS GETNEX      /TELL SERVER STARTING BLOCK NUMBER
 104 007627* 4305          JMS GETNUM      /RECEIVE CDF INSTRUCTION
 105 007630* 3231          DCA .+1         /SAVE AND THEN EXECUTE THE CDF
 106 007631* 7402          HLT             /BECOMES CDF TO XFER FIELD
 107 007632* 4305          JMS GETNUM      /RECEIVE NEGATIVE WORD COUNT
 108 007633* 3333          DCA WORDCT
 109 007634* 4305  GETACK, JMS GETNUM      /4000=READ, 4001=WRITE, 0000=DONE, 2000=ERROR
 110 007635* 7450          SNA             /WAS IT ZERO?
 111 007636* 5326          JMP EXIT        /YES, EXIT
 112 007637* 7104          CLL RAL         /NO, IS HIGH BIT SET?
 113 007640* 7420          SNL
 114 007641* 5331          JMP ERROR       /NO, ERROR!
 115 007642* 7640          SZA CLA         /YES, READ OR WRITE?
 116 007643* 5253          JMP TXLP        /TIME TO WRITE
 117               
 118 007644* 4305  RXLP,   JMS GETNUM      /GET WORD
 119 007645* 3662          DCA I SLOC      /STORE CONTENTS
 120 007646* 2262          ISZ SLOC        /NEXT LOCATION
 121 007647* 7000          NOP             /GUARD FOR ISZ
 122 007650* 2333          ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 123 007651* 5244          JMP RXLP        /NO, KEEP LOOPING
 124 007652* 5234          JMP GETACK      /ANY OTHER REQUESTS?
 125               
 126 007653* 1662  TXLP,   TAD I SLOC      /GET WORD
 127 007654* 2262          ISZ SLOC        /NEXT LOCATION
 128 007655* 7000          NOP
 129 007656* 4275          JMS SNDNUM      /SEND IT
 130 007657* 2333          ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 131 007660* 5253          JMP TXLP        /NO, KEEP LOOPING
 132 007661* 5234          JMP GETACK      /ANY MORE REQUESTS?
 133               
 134               SLOC,                   /REUSE THIS LOCATION
 135 007662* 0005  ENTRY2, VERS            /SECOND ENTRY POINT
 136 007663* 7200          CLA
 137 007664* 1262          TAD ENTRY2      /GET ARGUMENT ADDRESS
 138 007665* 3207          DCA ENTRY1      /STORE IT IN COMMON PLACE
 139 007666* 7301          CLA CLL IAC     /SET AC = 1 FOR 2ND PLATTER
 140 007667* 5211          JMP SETUP       /CONTINUE WITH SETUP
 141               
 142 007670* 0000  SENDC,  0               /SEND CHARACTER IN AC
 143 007671* 6416          STLS
 144 007672* 6411          STSF
 145 007673* 5272          JMP .-1
 146 007674* 5670          JMP I SENDC
 147                       
 148 007675* 0000  SNDNUM, 0               /SEND NUMBER AS TWO CONSECUTIVE CHARACTERS
 149 007676* 4270          JMS SENDC       /SEND BOTTOM 8 BITS OF WORD
 150 007677* 7012          RTR             /NO BSW HERE TO SUIT 8/I ETC
 151 007700* 7012          RTR             /SHIFT TOP BITS DOWN 6
 152 007701* 7012          RTR
 153 007702* 4270          JMS SENDC       /SEND TOP 4 BITS PLUS SOME - LET SERVER HANDLE IT
 154 007703* 7200          CLA
 155 007704* 5675          JMP I SNDNUM
 156               
 157 007705* 0000  GETNUM, 0
 158 007706* 6402          SKCC            /CLEAR AC AND FLAG
 159 007707* 6401          SKSF            /SKIP IF FLAG SET
 160 007710* 5307          JMP .-1
 161 007711* 6406          SKRB            /READ BUFFER WHICH IS FIRST SIXBIT
 162 007712* 7106          CLL RTL         /SHIFT SIXBIT TO BITS 0-5
 163 007713* 7006          RTL             /NO BSW TO SUIT 8/I ETC
 164 007714* 7006          RTL
 165 007715* 6401          SKSF            /SKIP IF FLAG SET
 166 007716* 5315          JMP .-1         /WHICH WILL BE THE 2ND SIXBIT
 167 007717* 6404          SKRS            /OR WITH AC TO GIVE 12 BIT WORD
 168 007720* 5705          JMP I GETNUM
 169               
 170 007721* 0000  GETNEX, 0               /PARAMETER HANDLER UTILITY
 171 007722* 1607          TAD I ENTRY1    /FETCH NEXT CALLING PARAMETER
 172 007723* 4275          JMS SNDNUM      /AND SEND IT TO THE SERVER
 173 007724* 2207          ISZ ENTRY1      /MOVE POINTER TO NEXT PARAMETER
 174 007725* 5721          JMP I GETNEX
 175               
 176 007726* 2207  EXIT,   ISZ ENTRY1      /NORMAL EXIT
 177 007727* 7402  SFIELD, HLT             /MODIFIED TO CDI
 178 007730* 5607          JMP I ENTRY1    /EXIT
 179 007731* 7130  ERROR,  CLL CML RAR     /ROTATE ERROR CODE AND SET NEGATIVE BIT
 180 007732* 5327          JMP SFIELD      /ERROR EXIT
 181                       
 182 007733* 0000  WORDCT, 0
 183 007734* 0101  WKUP,   101
 184 007735* 6203  SCDI,   CIF CDF 0
 185 007736* 0000          ZBLOCK 7744-.
     007737* 0000  
     007740* 0000  
     007741* 0000  
     007742* 0000  
     007743* 0000  
 186                       RELOC
 187               $

ADDR    0017
B7605   0044
BASER   6400
BASET   6410
BLKNUM  6260
BOOT    0000
BOOTMS  0045
BOOTX1  0013
BOOTX2  0014
BOOTX3  0015
BOOTX4  0016
ENDB    0046
ENTRY1  7607
ENTRY2  7662
ERROR   7731
EXIT    7726
GETACK  7634
GETNEX  7721
GETNUM  7705
RDLP    0026
RXLP    7644
SCDI    7735
SENDC   7670
SETUP   7611
SFIELD  7727
SKCC    6402
SKCF    6400 unreferenced
SKIE    6405
SKRB    6406
SKRS    6404
SKSF    6401
SLOC    7662
SNDNUM  7675
STCF    6412 unreferenced
STFL    6410 unreferenced
STLS    6416
STPC    6414 unreferenced
STSF    6411
STSK    6415 unreferenced
TXLP    7653
VERS    0005
WKUP    7734
WORDCT  7733
