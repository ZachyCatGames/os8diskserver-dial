   1               /SERIAL-BASED DISK SYSTEM - NON-SYS
   2               /NON-SYSTEM HANDLER FOR OS/8
   3               
   4               /KYLE OWEN      17/FEB/2014     - ORIGINAL TO VERSION D
   5               /BOB ADAMSON    16/NOV/2015     - EXTENDED TO 4 DISKS FOR NON-SYS
   6               /                               - REMOVED REDUNDANT CDFS
   7               /                               - DISABLED INTERRUPTS FROM HERE
   8               /                               - REPLACED BSWS WITH ROTATES
   9               /                               - EXTENDED ^C CHECKING TO READ LOOP
  10               /                               - NO CHECK ON WRITE BECAUSE SERVER WOULD HANG
  11               
  12               VERS="E&77
  13               
  14               BASER=6400              /USING DEVICE 40/41
  15               BASET=6410
  16               
  17               SKCF=BASER
  18               SKSF=BASER+1
  19               SKCC=BASER+2
  20               SKRS=BASER+4
  21               SKIE=BASER+5
  22               SKRB=BASER+6
  23               
  24               STFL=BASET
  25               STSF=BASET+1
  26               STCF=BASET+2
  27               STPC=BASET+4
  28               STSK=BASET+5
  29               STLS=BASET+6
  30               
  31               BLKNUM=6260
  32               
  33               /HANDLER SENDS:
  34               /A OR B FOR PRIMARY DISK, SIDE A OR B
  35               /C OR D FOR SECOND  DISK, SIDE A OR B
  36               /E OR F FOR THIRD   DISK, SIDE A OR B
  37               /G OR H FOR FOURTH  DISK, SIDE A OR B
  38               
  39                       *0
  40 000000  7770          -10             /EIGHT DEVICES (4 DISKS = 8 LOGICAL DISKS)
  41 000001  2304          DEVICE SDIS; DEVICE SDA0; 4640; SDA0&177; 0; 0
     000002  1123  
     000003  2304  
     000004  0160  
     000005  4640  
     000006  0053  
     000007  0000  
     000010  0000  
  42 000011  2304          DEVICE SDIS; DEVICE SDB0; 4640; SDB0&177; 0; 0
     000012  1123  
     000013  2304  
     000014  0260  
     000015  4640  
     000016  0052  
     000017  0000  
     000020  0000  
  43 000021  2304          DEVICE SDIS; DEVICE SDA1; 4640; SDA1&177; 0; 0
     000022  1123  
     000023  2304  
     000024  0161  
     000025  4640  
     000026  0051  
     000027  0000  
     000030  0000  
  44 000031  2304          DEVICE SDIS; DEVICE SDB1; 4640; SDB1&177; 0; 0
     000032  1123  
     000033  2304  
     000034  0261  
     000035  4640  
     000036  0050  
     000037  0000  
     000040  0000  
  45 000041  2304          DEVICE SDIS; DEVICE SDA2; 4640; SDA2&177; 0; 0
     000042  1123  
     000043  2304  
     000044  0162  
     000045  4640  
     000046  0047  
     000047  0000  
     000050  0000  
  46 000051  2304          DEVICE SDIS; DEVICE SDB2; 4640; SDB2&177; 0; 0
     000052  1123  
     000053  2304  
     000054  0262  
     000055  4640  
     000056  0046  
     000057  0000  
     000060  0000  
  47 000061  2304          DEVICE SDIS; DEVICE SDA3; 4640; SDA3&177; 0; 0
     000062  1123  
     000063  2304  
     000064  0163  
     000065  4640  
     000066  0045  
     000067  0000  
     000070  0000  
  48 000071  2304          DEVICE SDIS; DEVICE SDB3; 4640; SDB3&177; 0; 0
     000072  1123  
     000073  2304  
     000074  0263  
     000075  4640  
     000076  0044  
     000077  0000  
     000100  0000  
  49                       
  50                       *200
  51 000200  0000  SENDC,  0               /SEND CHARACTER IN AC
  52 000201  6416          STLS
  53 000202  6411          STSF
  54 000203  5202          JMP .-1         /WAIT FOR IT TO GO
  55 000204  5600          JMP I SENDC     /WE HAVE NOT CLEARED THE AC
  56                       
  57 000205  0000  SNDNUM, 0               /SEND 12-BIT WORD AS TWO CONSECUTIVE CHARACTERS
  58 000206  4200          JMS SENDC       /SEND BOTTOM 8 BITS OF WORD
  59 000207  7012          RTR             /NO BSW TO SUIT 8/I ETC
  60 000210  7012          RTR
  61 000211  7012          RTR
  62 000212  4200          JMS SENDC       /SEND TOP 4 BITS PLUS SOME - LET SERVER HANDLE IT.
  63 000213  7200          CLA
  64 000214  5605          JMP I SNDNUM    /EXIT WITH AC=0
  65               
  66 000215  0000  GETNUM, 0               /RECEIVE 1 WORD AS 2 SUCCESSIVE SIXBITS
  67 000216  6402          SKCC            /CLEAR AC AND FLAG
  68 000217  6401          SKSF            /WAITING FOR THE FLAG TO SET
  69 000220  5217          JMP .-1
  70 000221  6406          SKRB            /READ BUFFER WHICH WILL BE 1ST SIXBIT
  71 000222  7106          CLL RTL         /SHIFT SIXBIT TO BITS 0-5
  72 000223  7006          RTL             /NO BSW TO SUIT 8/I ETC
  73 000224  7006          RTL
  74 000225  6401          SKSF            /WAITING FOR THE NEXT FLAG
  75 000226  5225          JMP .-1         /WHICH WILL BE THE 2ND SIXBIT
  76 000227  6404          SKRS            /OR BUFFER WITH AC TO GIVE 12 BIT WORD
  77 000230  5615          JMP I GETNUM
  78               
  79 000231  0000  CTRLC,  0               /CHECK FOR ^C KEYBOARD INTERRUPTS
  80 000232  7600  S7600,  7600            /= CLA ALSO OS/8 ENTRY POINT
  81 000233  6031          KSF             /HAS THE KEYBOARD BEEN HIT?
  82 000234  5631          JMP I CTRLC     /NO, JUST GO AWAY
  83 000235  6034          KRS             /IF HE'S TYPED, READ THE KEY
  84 000236  0362          AND S177        /7 BITS ONLY IN CASE OF PARITY
  85 000237  1363          TAD M3          /^C IS CODE 203
  86 000240  7640          SZA CLA         /WAS IT ^C?
  87 000241  5631          JMP I CTRLC     /NO, JUST GO AWAY
  88 000242  6203  SCDI,   CIF CDF 0       /IF WE HAD A ^C, FORCE FIELD 0
  89 000243  5632          JMP I S7600     /AND EXIT TO OS/8
  90               
  91 000244  0005  SDB3,   VERS            /ENTRY POINT LIST (NOTE REVERSE ORDER)
  92 000245  2357  SDA3,   ISZ SDCNT       /COUNT UP WHERE WE ENTERED
  93 000246  2357  SDB2,   ISZ SDCNT       /EVENTUALLY SDCNT WILL BE
  94 000247  2357  SDA2,   ISZ SDCNT       /THE NUMBER OF THE ENTRY POINT
  95 000250  2357  SDB1,   ISZ SDCNT       /MINUS 1 COUNTING FROM THE TOP
  96 000251  2357  SDA1,   ISZ SDCNT       /IE SDCNT=7 FOR ENTRY SDB3
  97 000252  2357  SDB0,   ISZ SDCNT       /DOWN TO =0 FOR SDA0
  98 000253  2357  SDA0,   ISZ SDCNT       /FOR THIS ENTRY, SDCNT WILL =0
  99                                       /THE NEXT CONSTANT MUST STAY HERE
 100                                       /RELATIVE TO THE FOREGOING ENTRIES
 101 000254  0101  WKUP,   101             /"A" - ('AND' INSTRUCTION IS DON'T CARE)
 102 000255  7300          CLA CLL
 103 000256  6405          SKIE            /NO INTERRUPTS FROM THIS CONSOLE
 104 000257  1357          TAD SDCNT       /AC=ENTRY POINT NUMBER MINUS 1
 105 000260  7040          CMA             /AC=ENTRY POINT MINUS 8
 106 000261  1276          TAD SDTAD       /AC=TAD (ENTRY POINT)
 107 000262  3271          DCA SDGET       /READY TO SAVE ENTRY POINT VALUE
 108 000263  7332          CLA CLL CML RTR /=2000
 109 000264  1271          TAD SDGET       /AC=DCA (ENTRY POINT)
 110 000265  3274          DCA SRESTR      /GET READY TO REWRITE ENTRY POINT
 111 000266  6214          RDF             /GET THE CALLING DATA FIELD
 112 000267  1242          TAD SCDI        /AND MAKE A RETURN FIELD CHANGE
 113 000270  3353          DCA SFIELD      /FOR OUR EXIT
 114 000271  7402  SDGET,  HLT             /BECOMES TAD (ENTRY POINT)
 115 000272  3360          DCA SDENT       /WHICH IS START OF PARAMETER LIST
 116 000273  1361          TAD SDISZ       /GET THE ORIGINAL ISZ INSTRUCTION
 117 000274  7402  SRESTR, HLT             /AND RESET THE ENTRY POINT
 118                                       /OK, WE'RE ALL SET FOR THE TRANSFER
 119 000275  4231          JMS CTRLC       /SEE IF WE'RE BEING INTERRUPTED
 120 000276  1254  SDTAD,  TAD WKUP        /IF NOT GET WAKEUP CHARACTER 'A'
 121 000277  1357          TAD SDCNT       /ADD THE OFFSET (0-7, IE NOW 'A'-'H')
 122 000300  4200          JMS SENDC       /LET THE SERVER KNOW WHICH DEVICE
 123 000301  7200          CLA
 124 000302  3357          DCA SDCNT       /RESET THE ENTRY COUNTER FOR NEXT TIME
 125 000303  1760          TAD I SDENT     /GET FUNCTION
 126 000304  4205          JMS SNDNUM      /TELL SERVER REQD FUNCTION ETC.
 127 000305  2360          ISZ SDENT       /LOOK AT BUFFER ADDRESS
 128 000306  1760          TAD I SDENT     /GET BUFFER ADDRESS
 129 000307  4205          JMS SNDNUM      /TELL SERVER BUFFER ADDRESS
 130 000310  1760          TAD I SDENT     /GET BUFFER ADDRESS
 131 000311  3364          DCA SLOC        /STORE BUFFER ADDRESS FOR XFER
 132 000312  2360          ISZ SDENT       /LOOK AT STARTING BLOCK NUMBER
 133 000313  1760          TAD I SDENT     /GET STARTING BLOCK NUMBER
 134 000314  4205          JMS SNDNUM      /TELL SERVER STARTING BLOCK NUMBER
 135 000315  2360          ISZ SDENT       /LOOK AT ERROR RETURN
 136 000316  4215          JMS GETNUM      /RECEIVE CDF INSTRUCTION
 137 000317  3320          DCA .+1         /FOR TRANSFER
 138 000320  7402          HLT             /AND SET UP THE TRANSFER FIELD
 139 000321  4215          JMS GETNUM      /RECEIVE NEGATIVE WORD COUNT
 140 000322  3365          DCA WORDCT
 141 000323  4215  GETACK, JMS GETNUM      /4000=READ, 4001=WRITE, 0000=DONE, 2000=ERROR
 142 000324  7450          SNA             /WAS IT ZERO?
 143 000325  5351          JMP EXIT        /YES, EXIT
 144 000326  7104          CLL RAL         /NO, IS HIGH BIT SET?
 145 000327  7420          SNL
 146 000330  5355          JMP ERROR       /NO, ERROR!
 147 000331  7640          SZA CLA         /YES, READ OR WRITE?
 148 000332  5342          JMP TXLP        /TIME TO WRITE
 149               
 150                                       /READ ROUTINE
 151 000333  4215  RXLP,   JMS GETNUM      /GET WORD
 152 000334  3764          DCA I SLOC      /STORE CONTENTS
 153 000335  2364          ISZ SLOC        /NEXT LOCATION
 154 000336  4231          JMS CTRLC       /CHECK FOR ^C (A SKIP WOULDN'T MATTER)
 155 000337  2365          ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 156 000340  5333          JMP RXLP        /NO, KEEP LOOPING
 157 000341  5323          JMP GETACK      /CHECK FINAL ACKNOWLEDGEMENT
 158               
 159                                       /WRITE ROUTINE
 160 000342  1764  TXLP,   TAD I SLOC      /GET WORD
 161 000343  2364          ISZ SLOC        /NEXT LOCATION
 162 000344  7000          NOP             /CAN'T ABORT HERE - SERVER WOULD HANG
 163 000345  4205          JMS SNDNUM      /SEND IT
 164 000346  2365          ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 165 000347  5342          JMP TXLP        /NO, KEEP LOOPING
 166 000350  5323          JMP GETACK      /CHECK FINAL ACKNOWLEDGEMENT
 167               
 168 000351  2360  EXIT,   ISZ SDENT       /POINT TO NORMAL EXIT
 169 000352  4231          JMS CTRLC       /LAST CHECK FOR INTERRUPT
 170 000353  7402  SFIELD, HLT             /MODIFIED TO CDI
 171 000354  5760          JMP I SDENT     /EXIT TO APPROPRIATE ADDRESS
 172 000355  7130  ERROR,  CLL CML RAR     /ROTATE ERROR CODE AND SET NEGATIVE BIT
 173 000356  5353          JMP SFIELD      /ERROR EXIT
 174               
 175 000357  0000  SDCNT,  0               /TRACKER FOR ENTRY POINT NUMBER
 176 000360  0000  SDENT,  0               /SURROGATE FOR ENTRY POINT
 177 000361  2357  SDISZ,  ISZ SDCNT       /TO RESTORE ENTRY POINT
 178 000362  0177  S177,   177
 179 000363  7775  M3,     -3              /MINUS OF ^C 7-BIT CHARACTER
 180 000364  0000  SLOC,   0
 181 000365  0000  WORDCT, 0
 182               $$$$$$

BASER   6400
BASET   6410
BLKNUM  6260 unreferenced
CTRLC   0231
ERROR   0355
EXIT    0351
GETACK  0323
GETNUM  0215
M3      0363
RXLP    0333
S177    0362
S7600   0232
SCDI    0242
SDA0    0253
SDA1    0251
SDA2    0247
SDA3    0245
SDB0    0252
SDB1    0250
SDB2    0246
SDB3    0244
SDCNT   0357
SDENT   0360
SDGET   0271
SDISZ   0361
SDTAD   0276
SENDC   0200
SFIELD  0353
SKCC    6402
SKCF    6400 unreferenced
SKIE    6405
SKRB    6406
SKRS    6404
SKSF    6401
SLOC    0364
SNDNUM  0205
SRESTR  0274
STCF    6412 unreferenced
STFL    6410 unreferenced
STLS    6416
STPC    6414 unreferenced
STSF    6411
STSK    6415 unreferenced
TXLP    0342
VERS    0005
WKUP    0254
WORDCT  0365
