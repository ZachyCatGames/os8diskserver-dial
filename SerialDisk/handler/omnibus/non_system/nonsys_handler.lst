   1               /       SDSKNS OS/8 NON-SYSTEM HANDLER
   2               
   3               /       SERIAL INTERFACE-BASED DISK NON-SYSTEM DEVICE HANDLER [USE WITH PC SERVER].
   4               
   5               /       LAST EDIT: 13-NOV-2016 CJL
   6               
   7               /       EDIT HISTORY.
   8               
   9               /       13-NOV-2016     CHARLES LASNER  BUG FIX AND MAJOR SOURCE CODE CLEANUP.
  10               
  11               /       NOTABLE CHANGES.
  12               
  13               /       1) FIXED BUG ASSOCIATED WITH PRE-OMNIBUS SERIAL INTERFACES BY REORDERING THE
  14               /          CODE THUS OVERALL LENGTH IS UNCHANGED.
  15               
  16               /       2) THE LONG AWAITED MAJOR SOURCE CODE CLEANUP TO INCLUDE [BETTER] COMMENTS AND
  17               /          CONFORMANCE WITH PDP-8 SOURCE CODE CONVENTIONS.
  18               
  19               /       6) RELEASE UPDATED TO VERSION G.
  20               
  21               /       06-AUG-2016     CHARLES LASNER  CODE CLEANUP.
  22               
  23               /       NOTABLE CHANGES.
  24               
  25               /       1) ADDS THIS EDIT HISTORY.
  26               
  27               /       2) REMOVES MINOR INCOMPATIBLE SOURCE CODE QUIRKS.  [NOTE: ALL CHANGES MADE
  28               /          ARE COSMETIC, BUT TECHNICALLY VIOLATE THE PAL LANGUAGE SPECIFICATION.  OS/8
  29               /          PAL8 IS DEFICIENT AT FLAGGING CERTAIN ERRORS THAT WILL BE PROPERLY DETECTED
  30               /          BY OTHER ASSEMBLY PROGRAMS SUCH AS PAL III, P?S/8 PAL, THE
  31               /          LAP6-DIAL/DIAL-MS ASSEMBLER AND TOPS1O PAL10.]
  32               
  33               /       3) REMOVES INCOMPATIBILITY WITH LANGUAGE EXTENSIONS FOUND IN OTHER ASSEMBLERS
  34               /          [SUCH AS THE ERROR DIRECTIVE].
  35               
  36               /       4) DEVICE GROUP NAMES ARE MODIFIED FOR CONSISTENCY WITH THE SYSTEM HANDLER.
  37               
  38               /       5) MAJOR SOURCE CODE CLEANUP DEFERRED PENDING TESTING OF THE PROGRAM.  [NOTE:
  39               /          AMONG OTHER PROBLEMS, THE SOURCE CODE APPEARS TO BE A RECOVERY FROM A
  40               /          LISTING FILE AND DOES NOT CONFORM TO PDP-8 SOURCE CODE STANDARDS; OTHER
  41               /          THAN MORE RECENT MINOR EDITS, THERE ARE NO HORIZONTAL TAB CHARACTERS.]
  42               
  43               /       6) RELEASE UPDATED TO VERSION F.
  44               /      16-NOV-2015     BOB ADAMSON     FIRST MAJOR UPDATE.
  45               
  46               /       NOTE: THIS RELEASE DATE IS APPROXIMATE.  IT IS MORE LIKELY AN EARLY DATE IN A
  47               /       PERIOD THAT SPANS SEVERAL MONTHS.
  48               
  49               /       NOTABLE CHANGES:
  50               
  51               /       1) REMOVES REDUNDANT CDF INSTRUCTIONS TO SHORTEN THE CODE.
  52               
  53               /       2) REPLACES BSW INSTRUCTIONS WITH THREE ROTATE INSTRUCTIONS EACH TO MAINTAIN
  54               /          COMPATIBILITY WITH ALL "FAMILY OF 8" MACHINES INSTEAD OF OMNIBUS AND NEWER.
  55               
  56               /       3) DISABLES INTERRUPTS FROM WITHIN THE HANDLER.
  57               
  58               /       4) ADDS CONTROL-C CHECKING TO ABORT TO OS/8 KEYBOARD MONITOR.
  59               
  60               /       5) LIMITS CONTROL-C CHECKING TO READ OPERATIONS ONLY TO PREVENT THE SERVER
  61               /          FROM HANGING.
  62               
  63               /       6) SUPPORT NOW EXTENDED TO FOUR DISKS [REQUIRES UPDATED SERVER SOFTWARE].
  64               
  65               /       7) RELEASE UPDATED TO VERSION E.
  66               
  67               /       17-FEB-2014     KYLE OWEN       INITIAL RELEASE AND UPDATES.
  68               
  69               /       NOTABLE FEATURES:
  70               
  71               /       1) RUNS ON OMNIBUS MACHINES ONLY.
  72               
  73               /       2) HANDLES TWO DISKS.
  74               
  75               /       3) HANDLER RELEASED AT VERSION D.
  76               
  77               /       NUMERIC LOAD DEFINITIONS.
  78               
  79                       NL2000= CLA CLL CML RTR         /LOAD AC WITH 2000.
  80               
  81               /       MISCELLANEOUS DEFINITIONS.
  82               
  83                       BLKNUM= 6260                    /COUNT OF OS/8 RECORDS PER LOGICAL DEVICE.
  84                       DEVCNT= 10                      /EIGHT LOGICAL DEVICES SUPPORTED.
  85                       VERS=   "G&77                   /RELEASE VERSION.
  86               /      REMOTE LINE IOT DEFINITIONS.
  87               
  88                       REC=    40                      /DEVICE 40 FOR REMOTE RECEIVE.
  89                       SEN=    41                      /DEVICE CODE 41 FOR REMOTE SEND.
  90               
  91               /       NOTE: DEFINITIONS THAT END WITH ^^^^ IN THE COMMENTS ARE FOR OMNIBUS OR NEWER
  92               /       MACHINES ONLY; EXECUTION MAY PRODUCE UNEXPECTED RESULTS!
  93               
  94               /       RECEIVE DEFINITIONS.
  95               
  96                       RKCC=   REC^10+6002             /CLEAR AC, RECEIVE FLAG.
  97                       RKCF=   REC^10+6000             /CLEAR RECEIVE FLAG ONLY.                   ^^^^
  98                       RKIE=   REC^10+6005             /LOAD INTERRUPT ENABLE PER AC[11].          ^^^^
  99                       RKRB=   REC^10+6006             /LOAD RECEIVE DATA -> AC, CLEAR RECEIVE FLAG.
 100                       RKRS=   REC^10+6004             /LOAD RECEIVE DATA .OR. AC -> AC.
 101                       RKSF=   REC^10+6001             /SKIP IF RECEIVE FLAG SET.
 102               
 103               /       TRANSMIT DEFINITIONS.
 104               
 105                       RSBIOT= SEN^10+6003             /SET BAUD RATE FROM AC[8-11].               ^^^^
 106                       RTCF=   SEN^10+6002             /CLEAR TRANSMIT FLAG.
 107                       RTFL=   SEN^10+6000             /SET TRANSMIT FLAG.                         ^^^^
 108                       RTLS=   SEN^10+6006             /SEND TRANSMIT CHARACTER, CLEAR FLAG.
 109                       RTPC=   SEN^10+6004             /SEND TRANSMIT CHARACTER.
 110                       RTSF=   SEN^10+6001             /SKIP ON TRANSMIT FLAG SET.
 111                       RTSK=   SEN^10+6005             /SKIP IF TRANSIT FLAG OR RECEIVE FLAG SET.  ^^^^
 112               
 113               /       TO DIFFERENTIATE BETWEEN LOGICAL DISK REGIONS, THE HANDLER SENDS AN
 114               /       INITIATING CHARACTER:
 115               
 116               /       ASCII TEXT CHARACTER    DISK REGION
 117               
 118               /               A               DISK 0 FIRST HALF.
 119               /               B               DISK 0 SECOND HALF.
 120               /               C               DISK 1 FIRST HALF.
 121               /               D               DISK 1 SECOND HALF.
 122               /               E               DISK 2 FIRST HALF.
 123               /               F               DISK 2 SECOND HALF.
 124               /               G               DISK 3 FIRST HALF.
 125               /               H               DISK 3 SECOND HALF.
 126                      *0                              /HANDLER BLOCK STARTS HERE.
 127               
 128 000000  7770          -DEVCNT                         /DEVICE HANDLER COUNT.
 129               
 130 000001  2304          DEVICE  SDNS;DEVICE  SDA0;4640;SDA0&177;0;0
     000002  1623  
     000003  2304  
     000004  0160  
     000005  4640  
     000006  0053  
     000007  0000  
     000010  0000  
 131 000011  2304          DEVICE  SDNS;DEVICE  SDB0;4640;SDB0&177;0;0
     000012  1623  
     000013  2304  
     000014  0260  
     000015  4640  
     000016  0052  
     000017  0000  
     000020  0000  
 132 000021  2304          DEVICE  SDNS;DEVICE  SDA1;4640;SDA1&177;0;0
     000022  1623  
     000023  2304  
     000024  0161  
     000025  4640  
     000026  0051  
     000027  0000  
     000030  0000  
 133 000031  2304          DEVICE  SDNS;DEVICE  SDB1;4640;SDB1&177;0;0
     000032  1623  
     000033  2304  
     000034  0261  
     000035  4640  
     000036  0050  
     000037  0000  
     000040  0000  
 134 000041  2304         DEVICE  SDNS;DEVICE  SDA2;4640;SDA2&177;0;0
     000042  1623  
     000043  2304  
     000044  0162  
     000045  4640  
     000046  0047  
     000047  0000  
     000050  0000  
 135 000051  2304          DEVICE  SDNS;DEVICE  SDB2;4640;SDB2&177;0;0
     000052  1623  
     000053  2304  
     000054  0262  
     000055  4640  
     000056  0046  
     000057  0000  
     000060  0000  
 136 000061  2304          DEVICE  SDNS;DEVICE  SDA3;4640;SDA3&177;0;0
     000062  1623  
     000063  2304  
     000064  0163  
     000065  4640  
     000066  0045  
     000067  0000  
     000070  0000  
 137 000071  2304          DEVICE  SDNS;DEVICE  SDB3;4640;SDB3&177;0;0
     000072  1623  
     000073  2304  
     000074  0263  
     000075  4640  
     000076  0044  
     000077  0000  
     000100  0000  
 138                      *200                            /CODE DEFINED HERE.
 139               
 140 000200  0000  SENDC,  .-.                             /TRANSMIT A CHARACTER ROUTINE.
 141 000201  6416          RTLS                            /SEND THE CHARACTER IN THE AC.
 142 000202  6411          RTSF                            /SEND FLAG UP?
 143 000203  5202          JMP     .-1                     /NO, WAIT FOR IT.
 144 000204  5600          JMP I   SENDC                   /YES, RETURN TO CALLER WITH AC INTACT.
 145               
 146 000205  0000  SNDNUM, .-.                             /SEND C(AC) AS TWO CHARACTERS ROUTINE.
 147 000206  4200          JMS     SENDC                   /SEND LOW-ORDER 8 BITS.
 148 000207  7012          RTR;RTR;RTR                     /MOVE DOWN HIGH-ORDER BITS.
     000210  7012  
     000211  7012  
 149 000212  4200          JMS     SENDC                   /SEND HIGH-ORDER BITS [AND SOME JUNK BITS].
 150 000213  7200          CLA                             /CLEAN UP.
 151 000214  5605          JMP I   SNDNUM                  /RETURN TO CALLER.
 152               
 153 000215  0000  GETNUM, .-.                             /RECEIVE 12-BIT WORD IN TWO CHARACTERS ROUTINE.
 154 000216  6402          RKCC                            /CLEAR THE RECEIVE FLAG, AC.
 155 000217  6401          RKSF                            /RECEIVE FLAG UP?
 156 000220  5217          JMP     .-1                     /NO, WAIT FOR IT.
 157 000221  6406          RKRB                            /YES, READ IN FIRST SIXBIT CHARACTER.
 158 000222  7106          CLL RTL;RTL;RTL                 /MOVE UP TO HIGH-ORDER BITS.
     000223  7006  
     000224  7006  
 159 000225  6401          RKSF                            /RECEIVE FLAG UP?
 160 000226  5225          JMP     .-1                     /NO, WAIT FOR IT.
 161 000227  6404          RKRS                            /.OR. SECOND SIXBIT CHARACTER INTO AC.
 162 000230  5615          JMP I   GETNUM                  /RETURN TO CALLER.
 163               
 164 000231  0000  CTRLC,  .-.                             /CONTROL-C CHECK ROUTINE.
 165 000232  7600  S7600,  CLA!400                         /CLEAR AC; ALSO CONSTANT 7600.
 166 000233  6031          KSF                             /KEYBOARD FLAG UP?
 167 000234  5631          JMP I   CTRLC                   /NO, RETURN NOW.
 168 000235  6034          KRS                             /YES, GET THE LATEST CHARACTER.
 169 000236  0263          AND     S177/(177)              /REMOVE PARITY BIT.
 170 000237  1363          TAD     M3/(-3)                 /COMPARE TO CONTROL-C.
 171 000240  7640          SZA CLA                         /SKIP IF IT MATCHES.
 172 000241  5631          JMP I   CTRLC                   /RETURN IF DIFFERENT FROM CONTROL-C.
 173 000242  6203  SCDI,   CIF CDF 00                      /GOING TO FIELD 0 ON ABORT.
 174 000243  5632          JMP I   S7600/(7600)            /EXIT TO OS/8.
 175               /      HANDLER ENTRY POINTS.
 176               
 177               /       NOTE: ALL HANDLER ENTRY POINTS FOLLOW IN REVERSE ORDER.
 178               
 179 000244  0007  SDB3,   VERS                            /FIRST ENTRY POINT CONTAINS VERSION NUMBER.
 180 000245  2360  SDA3,   ISZ     SDCNT                   /SECOND ENTRY POINT.
 181 000246  2360  SDB2,   ISZ     SDCNT                   /THIRD ENTRY POINT.
 182 000247  2360  SDA2,   ISZ     SDCNT                   /FOURTH ENTRY POINT.
 183 000250  2360  SDB1,   ISZ     SDCNT                   /FIFTH ENTRY POINT.
 184 000251  2360  SDA1,   ISZ     SDCNT                   /SIXTH ENTRY POINT.
 185 000252  2360  SDB0,   ISZ     SDCNT                   /SEVENTH ENTRY POINT.
 186 000253  2360  SDA0,   ISZ     SDCNT                   /EIGHTH ENTRY POINT.
 187               
 188               /       AT THIS POINT, "SDCNT" HAS BEEN BUMPED 0 THROUGH 7 TIMES DEPENDING ON WHICH
 189               /       ENTRY POINT WAS USED.  WE USE THIS COUNT TO DETERMINE WHICH ENTRY WAS USED.
 190               
 191               /       THE NEXT WORD EXECUTES AS A HARMLESS "AND" INSTRUCTION TO PROVIDE PARTIAL
 192               /       PROTECTION FROM CALLS MADE FROM LOCATIONS NEAR THE END OF THE CALLING FIELD.
 193               /       WHILE THIS IS NOT FOOLPROOF, CALLS IN OS/8 ARE SELDOM MADE FROM LOCATIONS PAST
 194               /       X7600 FOR ANY FIELD X IN THE RANGE OF 0-7.
 195               
 196               /       ADDITIONALLY, "WKUP" MUST BE JUST AFTER THE ENTRY POINT CHAIN TO HELP DEFINE
 197               /       REFERENCES TO THE PROPER ENTRY POINT.
 198               
 199                       IFNZRO  SDA0+1-. <ERROR .>      /ASSEMBLES ONLY IF THE LOGIC IS BUNGLED.
 200               
 201 000254  0101  WKUP,   "A&177                          /CONSTANT 0101; ALSO HARMLESS "AND" INSTRUCTION.
 202 000255  7300          CLA CLL                         /CLEAN UP.
 203 000256  1360          TAD     SDCNT                   /GET ENTRY POINT COUNTER
 204 000257  7040          CMA                             /INVERT
 205 000260  1277          TAD     SDTAD/(TAD WKUP)        /NOW HAVE "TAD" TO THE PROPER ENTRY POINT.
 206 000261  3272          DCA     SDGET                   /STORE INLINE FOR USE LATER.
 207 000262  6405          RKIE                            /CLEAR INTERRUPTS FROM THIS DEVICE.
 208 000263  0177  S177,   177                             /CONSTANT 0177; HERE IN CASE THE PREVIOUS SKIPS.
 209 000264  7332          NL2000                          /SET AC TO "DCA" - "TAD" OFFSET.
 210 000265  1272          TAD     SDGET                   /NOW HAVE "DCA" TO THE PROPER ENTRY POINT.
 211 000266  3275          DCA     SRESTR                  /STORE INLINE TO RESTORE CALLED ENTRY POINT.
 212 000267  6214          RDF                             /GET THE CALLER'S FIELD.
 213 000270  1242          TAD     SCDI/(CIF CDF)          /TURN INTO "CIF CDF" RETURN FIELD INSTRUCTION.
 214 000271  3354          DCA     SFIELD                  /STORE INLINE FOR RETURN LATER.
 215 000272  7402  SDGET,  HLT                             /THIS IS NOW "TAD" TO THE CHOSEN ENTRY POINT.
 216 000273  3361          DCA     SDENT                   /SAVE IT TO GET THE INLINE ARGUMENTS.
 217 000274  1362          TAD     SDISZ/(ISZ SDCNT)       /GET THE NORMAL CONTENTS
 218 000275  7402  SRESTR, HLT                             /SAVE OVER THE CALLED ENTRY POINT.
 219 000276  4231          JMS     CTRLC                   /CHECK FOR CONTROL-C ABORT NOW.
 220 000277  1254  SDTAD,  TAD     WKUP/("A&177)           /GET THE DRIVE BASE CHARACTER.
 221 000300  1360          TAD     SDCNT                   /ADD OFFSET TO THE DESIRED [HALF] DRIVE.
 222 000301  4200          JMS     SENDC                   /TELL IT TO THE SERVER.
 223 000302  7200          CLA                             /CLEAN UP.
 224 000303  3360          DCA     SDCNT                   /RESET THE ENTRY COUNTER FOR NEXT TIME.
 225 000304  1761         TAD I   SDENT                   /GET THE FUNCTION WORD.
 226 000305  4205          JMS     SNDNUM                  /SEND IT TO THE SERVER.
 227 000306  2361          ISZ     SDENT                   /BUMP PAST FUNCTION WORD.
 228 000307  1761          TAD I   SDENT                   /GET THE CALLER'S BUFFER ADDRESS.
 229 000310  4205          JMS     SNDNUM                  /TELL IT TO THE SERVER [THIS COULD GO AWAY].
 230 000311  1761          TAD I   SDENT                   /GET THE CALLER'S BUFFER ADDRESS AGAIN.
 231 000312  3364          DCA     SLOC                    /STORE FOR TRANSFERS LATER.
 232 000313  2361          ISZ     SDENT                   /BUMP TO RECORD ARGUMENT.
 233 000314  1761          TAD I   SDENT                   /GET THE STARTING RECORD NUMBER.
 234 000315  4205          JMS     SNDNUM                  /SET TO SERVER.
 235 000316  2361          ISZ     SDENT                   /BUMP TO ERROR RETURN.
 236 000317  4215          JMS     GETNUM                  /GET "CDF" TO BUFFER FIELD FROM SERVER.
 237 000320  3321          DCA     .+1                     /STORE INLINE.
 238 000321  7402          HLT                             /CHANGE DATA FIELD TO USER'S BUFFER FIELD.
 239 000322  4215          JMS     GETNUM                  /GET NEGATED WORD COUNT FROM SERVER.
 240 000323  3365          DCA     WORDCT                  /STASH IT.
 241 000324  4215  GETACK, JMS     GETNUM                  /GET STATUS FROM SERVER.
 242 000325  7450          SNA                             /ARE WE DONE? [0000 IS GOOD COMPLETION CODE.]
 243 000326  5352          JMP     EXIT                    /YES, TAKE GOOD EXIT NOW.
 244 000327  7104          CLL RAL                         /MOVE UP TO LINK AND AC[0].
 245 000330  7420          SNL                             /SKIP IF READ OR WRITE.
 246 000331  5356          JMP     DSKERR                  /JUMP IF THERE WAS AN ERROR [CODE 2000].
 247 000332  7640          SZA CLA                         /SKIP IF READING [4000].
 248 000333  5343          JMP     TXLP                    /JUMP IF WE ARE WRITING [4001].
 249               
 250               /       FALLS THROUGH IF READING.  GET THE DATA FROM THE SERVER AND STORE INTO THE
 251               /       USER'S BUFFER.
 252               
 253 000334  4215  RXLP,   JMS     GETNUM                  /GET A WORD FROM THE SERVER.
 254 000335  3764          DCA I   SLOC                    /PUT A WORD INTO THE BUFFER.
 255 000336  2364          ISZ     SLOC                    /BUMP UP THE BUFFER POINTER.
 256 000337  4231          JMS     CTRLC                   /CHECK FOR CONTROL-C [MIGHT BE SKIPPED].
 257 000340  2365          ISZ     WORDCT                  /DONE ENOUGH WORDS?
 258 000341  5334          JMP     RXLP                    /NO, KEEP GOING.
 259 000342  5324          JMP     GETACK                  /GET THE FINAL STATUS BEFORE EXITING.
 260               
 261               /       COMES HERE IF WRITING.  GET THE DATA FROM THE USER'S BUFFER AND SEND IT TO THE
 262               /       SERVER.
 263               
 264 000343  1764  TXLP,   TAD I   SLOC                    /GET A WORD FROM THE USER'S BUFFER.
 265 000344  2364          ISZ     SLOC                    /BUMP TO NEXT LOCATION.
 266 000345  7000          NOP                             /HERE IN CASE IT SKIPS.
 267 000346  4205          JMS     SNDNUM                  /SEND THE WORD TO THE SERVER.
 268 000347  2365          ISZ     WORDCT                  /DONE ENOUGH WORDS?
 269 000350  5343          JMP     TXLP                    /NO, KEEP GOING.
 270 000351  5324          JMP     GETACK                  /GET THE FINAL STATUS BEFORE EXITING.
 271               /      COMES HERE FOR SUCCESSFUL EXIT TO CALLER.
 272               
 273 000352  2361  EXIT,   ISZ     SDENT                   /BUMP TO NORMAL RETURN.
 274 000353  4231          JMS     CTRLC                   /CHECK FOR CONTROL-C ONE LAST TIME.
 275 000354  7402  SFIELD, HLT                             /THIS WILL BE "CIF CDF" TO CALLER'S FIELD.
 276 000355  5761          JMP I   SDENT                   /TAKE GOOD RETURN TO CALLER.
 277               
 278               /       COMES HERE IF THERE WAS AN ERROR.
 279               
 280 000356  7130  DSKERR, STL RAR                         /FORCE ERROR CONDITION AND MOVE DOWN STATUS BITS.
 281 000357  5354          JMP     SFIELD                  /TAKE ERROR RETURN.
 282               
 283 000360  0000  SDCNT,  0                               /THIS IS USED TO DETERMINE THE ACTIVE CALLER.
 284 000361  0000  SDENT,  .-.                             /POINTER TO INLINE ARGUMENTS.
 285 000362  2360  SDISZ,  ISZ     SDCNT                   /INSTRUCTION CONSTANT NEEDED FOR RESTORATION.
 286 000363  7775  M3,     -3                              /CONSTANT 7775.
 287 000364  0000  SLOC,   .-.                             /POINTER TO USER'S BUFFER.
 288 000365  0000  WORDCT, .-.                             /WORD COUNT FOR DATA TRANSFER.
 289               
 290                       $                               /THAT'S ALL, FOLK!

BLKNUM  6260 unreferenced
CTRLC   0231
DEVCNT  0010
DSKERR  0356
EXIT    0352
GETACK  0324
GETNUM  0215
M3      0363
NL2000  7332
REC     0040
RKCC    6402
RKCF    6400 unreferenced
RKIE    6405
RKRB    6406
RKRS    6404
RKSF    6401
RSBIOT  6413 unreferenced
RTCF    6412 unreferenced
RTFL    6410 unreferenced
RTLS    6416
RTPC    6414 unreferenced
RTSF    6411
RTSK    6415 unreferenced
RXLP    0334
S177    0263
S7600   0232
SCDI    0242
SDA0    0253
SDA1    0251
SDA2    0247
SDA3    0245
SDB0    0252
SDB1    0250
SDB2    0246
SDB3    0244
SDCNT   0360
SDENT   0361
SDGET   0272
SDISZ   0362
SDTAD   0277
SEN     0041
SENDC   0200
SFIELD  0354
SLOC    0364
SNDNUM  0205
SRESTR  0275
TXLP    0343
VERS    0007
WKUP    0254
WORDCT  0365
