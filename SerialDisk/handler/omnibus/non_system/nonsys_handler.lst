   1               /       SDSKNS OS/8 NON-SYSTEM HANDLER
   2               
   3               /       SERIAL INTERFACE-BASED DISK NON-SYSTEM DEVICE HANDLER [USE WITH PC SERVER].
   4               
   5               /       LAST EDIT: 06-AUG-2016 CJL
   6               
   7               /       EDIT HISTORY.
   8               
   9               /       06-AUG-2016     CHARLES LASNER  CODE CLEANUP.
  10               
  11               /       NOTABLE CHANGES.
  12               
  13               /       1) ADDS THIS EDIT HISTORY.
  14               
  15               /       2) REMOVES MINOR INCOMPATIBLE SOURCE CODE QUIRKS.  [NOTE: ALL CHANGES MADE
  16               /          ARE COSMETIC, BUT TECHNICALLY VIOLATE THE PAL LANGUAGE SPECIFICATION.  OS/8
  17               /          PAL8 IS DEFICIENT AT FLAGGING CERTAIN ERRORS THAT WILL BE PROPERLY DETECTED
  18               /          BY OTHER ASSEMBLY PROGRAMS SUCH AS PAL III, P?S/8 PAL, THE LAP6-DIAL/DIAL-MS
  19               /          ASSEMBLER AND TOPS1O PAL10.]
  20               
  21               /       3) REMOVES INCOMPATIBILITY WITH LANGUAGE EXTENSIONS FOUND IN OTHER ASSEMBLERS
  22               /          [SUCH AS THE ERROR DIRECTIVE].
  23               
  24               /       4) DEVICE GROUP NAMES ARE MODIFIED FOR CONSISTENCY WITH THE SYSTEM HANDLER.
  25               
  26               /       5) MAJOR SOURCE CODE CLEANUP DEFERRED PENDING TESTING OF THE PROGRAM.  [NOTE:
  27               /          AMONG OTHER PROBLEMS, THE SOURCE CODE APPEARS TO BE A RECOVERY FROM A
  28               /          LISTING FILE AND DOES NOT CONFORM TO PDP-8 SOURCE CODE STANDARDS; OTHER THAN
  29               /          MORE RECENT MINOR EDITS, THERE ARE NO HORIZONTAL TAB CHARACTERS.]
  30               
  31               /       6) RELEASE UPDATED TO VERSION F.
  32               
  33               /       16-NOV-2015     BOB ADAMSON     FIRST MAJOR UPDATE.
  34               
  35               /       NOTE: THIS RELEASE DATE IS APPROXIMATE.  IT IS MORE LIKELY AN EARLY DATE IN A
  36               /       PERIOD THAT SPANS SEVERAL MONTHS.
  37               
  38               /       NOTABLE CHANGES:
  39               
  40               /       1) REMOVES REDUNDANT CDF INSTRUCTIONS TO SHORTEN THE CODE.
  41               
  42               /       2) REPLACES BSW INSTRUCTIONS WITH THREE ROTATE INSTRUCTIONS EACH TO MAINTAIN
  43               /          COMPATIBILITY WITH ALL "FAMILY OF 8" MACHINES INSTEAD OF OMNIBUS AND NEWER.
  44               
  45               /       3) DISABLES INTERRUPTS FROM WITHIN THE HANDLER.
  46               
  47               /       4) ADDS CONTROL-C CHECKING TO ABORT TO OS/8 KEYBOARD MONITOR.
  48               
  49               /       5) LIMITS CONTROL-C CHECKING TO READ OPERATIONS ONLY TO PREVENT THE SERVER
  50               /          FROM HANGING.
  51               
  52               /       6) SUPPORT NOW EXTENDED TO FOUR DISKS [REQUIRES UPDATED SERVER SOFTWARE].
  53               
  54               /       7) RELEASE UPDATED TO VERSION E.
  55               
  56               /       17-FEB-2014     KYLE OWEN       INITIAL RELEASE AND UPDATES.
  57               
  58               /       NOTABLE FEATURES:
  59               
  60               /       1) RUNS ON OMNIBUS MACHINES ONLY.
  61               
  62               /       2) HANDLES TWO DISKS.
  63               
  64               /       3) HANDLER RELEASED AT VERSION D.
  65               
  66               VERS="F&77
  67               
  68               BASER=6400              /USING DEVICE 40/41
  69               BASET=6410
  70               
  71               SKCF=BASER
  72               SKSF=BASER+1
  73               SKCC=BASER+2
  74               SKRS=BASER+4
  75               SKIE=BASER+5
  76               SKRB=BASER+6
  77               
  78               STFL=BASET
  79               STSF=BASET+1
  80               STCF=BASET+2
  81               STPC=BASET+4
  82               STSK=BASET+5
  83               STLS=BASET+6
  84               
  85               BLKNUM=6260
  86               
  87               /HANDLER SENDS:
  88               /A OR B FOR PRIMARY DISK, SIDE A OR B
  89               /C OR D FOR SECOND  DISK, SIDE A OR B
  90               /E OR F FOR THIRD   DISK, SIDE A OR B
  91               /G OR H FOR FOURTH  DISK, SIDE A OR B
  92               
  93                       *0
  94 000000  7770          -10             /EIGHT DEVICES (4 DISKS = 8 LOGICAL DISKS)
  95 000001  2304          DEVICE SDNS; DEVICE SDA0; 4640; SDA0&177; 0; 0
     000002  1623  
     000003  2304  
     000004  0160  
     000005  4640  
     000006  0053  
     000007  0000  
     000010  0000  
  96 000011  2304          DEVICE SDNS; DEVICE SDB0; 4640; SDB0&177; 0; 0
     000012  1623  
     000013  2304  
     000014  0260  
     000015  4640  
     000016  0052  
     000017  0000  
     000020  0000  
  97 000021  2304          DEVICE SDNS; DEVICE SDA1; 4640; SDA1&177; 0; 0
     000022  1623  
     000023  2304  
     000024  0161  
     000025  4640  
     000026  0051  
     000027  0000  
     000030  0000  
  98 000031  2304          DEVICE SDNS; DEVICE SDB1; 4640; SDB1&177; 0; 0
     000032  1623  
     000033  2304  
     000034  0261  
     000035  4640  
     000036  0050  
     000037  0000  
     000040  0000  
  99 000041  2304          DEVICE SDNS; DEVICE SDA2; 4640; SDA2&177; 0; 0
     000042  1623  
     000043  2304  
     000044  0162  
     000045  4640  
     000046  0047  
     000047  0000  
     000050  0000  
 100 000051  2304          DEVICE SDNS; DEVICE SDB2; 4640; SDB2&177; 0; 0
     000052  1623  
     000053  2304  
     000054  0262  
     000055  4640  
     000056  0046  
     000057  0000  
     000060  0000  
 101 000061  2304          DEVICE SDNS; DEVICE SDA3; 4640; SDA3&177; 0; 0
     000062  1623  
     000063  2304  
     000064  0163  
     000065  4640  
     000066  0045  
     000067  0000  
     000070  0000  
 102 000071  2304          DEVICE SDNS; DEVICE SDB3; 4640; SDB3&177; 0; 0
     000072  1623  
     000073  2304  
     000074  0263  
     000075  4640  
     000076  0044  
     000077  0000  
     000100  0000  
 103                       
 104                       *200
 105 000200  0000  SENDC,  0               /SEND CHARACTER IN AC
 106 000201  6416          STLS
 107 000202  6411          STSF
 108 000203  5202          JMP .-1         /WAIT FOR IT TO GO
 109 000204  5600          JMP I SENDC     /WE HAVE NOT CLEARED THE AC
 110                       
 111 000205  0000  SNDNUM, 0               /SEND 12-BIT WORD AS TWO CONSECUTIVE CHARACTERS
 112 000206  4200          JMS SENDC       /SEND BOTTOM 8 BITS OF WORD
 113 000207  7012          RTR             /NO BSW TO SUIT 8/I ETC
 114 000210  7012          RTR
 115 000211  7012          RTR
 116 000212  4200          JMS SENDC       /SEND TOP 4 BITS PLUS SOME - LET SERVER HANDLE IT.
 117 000213  7200          CLA
 118 000214  5605          JMP I SNDNUM    /EXIT WITH AC=0
 119               
 120 000215  0000  GETNUM, 0               /RECEIVE 1 WORD AS 2 SUCCESSIVE SIXBITS
 121 000216  6402          SKCC            /CLEAR AC AND FLAG
 122 000217  6401          SKSF            /WAITING FOR THE FLAG TO SET
 123 000220  5217          JMP .-1
 124 000221  6406          SKRB            /READ BUFFER WHICH WILL BE 1ST SIXBIT
 125 000222  7106          CLL RTL         /SHIFT SIXBIT TO BITS 0-5
 126 000223  7006          RTL             /NO BSW TO SUIT 8/I ETC
 127 000224  7006          RTL
 128 000225  6401          SKSF            /WAITING FOR THE NEXT FLAG
 129 000226  5225          JMP .-1         /WHICH WILL BE THE 2ND SIXBIT
 130 000227  6404          SKRS            /OR BUFFER WITH AC TO GIVE 12 BIT WORD
 131 000230  5615          JMP I GETNUM
 132               
 133 000231  0000  CTRLC,  0               /CHECK FOR ^C KEYBOARD INTERRUPTS
 134 000232  7600  S7600,  7600            /= CLA ALSO OS/8 ENTRY POINT
 135 000233  6031          KSF             /HAS THE KEYBOARD BEEN HIT?
 136 000234  5631          JMP I CTRLC     /NO, JUST GO AWAY
 137 000235  6034          KRS             /IF HE'S TYPED, READ THE KEY
 138 000236  0362          AND S177        /7 BITS ONLY IN CASE OF PARITY
 139 000237  1363          TAD M3          /^C IS CODE 203
 140 000240  7640          SZA CLA         /WAS IT ^C?
 141 000241  5631          JMP I CTRLC     /NO, JUST GO AWAY
 142 000242  6203  SCDI,   CIF CDF 0       /IF WE HAD A ^C, FORCE FIELD 0
 143 000243  5632          JMP I S7600     /AND EXIT TO OS/8
 144               
 145 000244  0006  SDB3,   VERS            /ENTRY POINT LIST (NOTE REVERSE ORDER)
 146 000245  2357  SDA3,   ISZ SDCNT       /COUNT UP WHERE WE ENTERED
 147 000246  2357  SDB2,   ISZ SDCNT       /EVENTUALLY SDCNT WILL BE
 148 000247  2357  SDA2,   ISZ SDCNT       /THE NUMBER OF THE ENTRY POINT
 149 000250  2357  SDB1,   ISZ SDCNT       /MINUS 1 COUNTING FROM THE TOP
 150 000251  2357  SDA1,   ISZ SDCNT       /IE SDCNT=7 FOR ENTRY SDB3
 151 000252  2357  SDB0,   ISZ SDCNT       /DOWN TO =0 FOR SDA0
 152 000253  2357  SDA0,   ISZ SDCNT       /FOR THIS ENTRY, SDCNT WILL =0
 153                                       /THE NEXT CONSTANT MUST STAY HERE
 154                                       /RELATIVE TO THE FOREGOING ENTRIES
 155 000254  0101  WKUP,   101             /"A" - ('AND' INSTRUCTION IS DON'T CARE)
 156 000255  7300          CLA CLL
 157 000256  6405          SKIE            /NO INTERRUPTS FROM THIS CONSOLE
 158 000257  1357          TAD SDCNT       /AC=ENTRY POINT NUMBER MINUS 1
 159 000260  7040          CMA             /AC=ENTRY POINT MINUS 8
 160 000261  1276          TAD SDTAD       /AC=TAD (ENTRY POINT)
 161 000262  3271          DCA SDGET       /READY TO SAVE ENTRY POINT VALUE
 162 000263  7332          CLA CLL CML RTR /=2000
 163 000264  1271          TAD SDGET       /AC=DCA (ENTRY POINT)
 164 000265  3274          DCA SRESTR      /GET READY TO REWRITE ENTRY POINT
 165 000266  6214          RDF             /GET THE CALLING DATA FIELD
 166 000267  1242          TAD SCDI        /AND MAKE A RETURN FIELD CHANGE
 167 000270  3353          DCA SFIELD      /FOR OUR EXIT
 168 000271  7402  SDGET,  HLT             /BECOMES TAD (ENTRY POINT)
 169 000272  3360          DCA SDENT       /WHICH IS START OF PARAMETER LIST
 170 000273  1361          TAD SDISZ       /GET THE ORIGINAL ISZ INSTRUCTION
 171 000274  7402  SRESTR, HLT             /AND RESET THE ENTRY POINT
 172                                       /OK, WE'RE ALL SET FOR THE TRANSFER
 173 000275  4231          JMS CTRLC       /SEE IF WE'RE BEING INTERRUPTED
 174 000276  1254  SDTAD,  TAD WKUP        /IF NOT GET WAKEUP CHARACTER 'A'
 175 000277  1357          TAD SDCNT       /ADD THE OFFSET (0-7, IE NOW 'A'-'H')
 176 000300  4200          JMS SENDC       /LET THE SERVER KNOW WHICH DEVICE
 177 000301  7200          CLA
 178 000302  3357          DCA SDCNT       /RESET THE ENTRY COUNTER FOR NEXT TIME
 179 000303  1760          TAD I SDENT     /GET FUNCTION
 180 000304  4205          JMS SNDNUM      /TELL SERVER REQD FUNCTION ETC.
 181 000305  2360          ISZ SDENT       /LOOK AT BUFFER ADDRESS
 182 000306  1760          TAD I SDENT     /GET BUFFER ADDRESS
 183 000307  4205          JMS SNDNUM      /TELL SERVER BUFFER ADDRESS
 184 000310  1760          TAD I SDENT     /GET BUFFER ADDRESS
 185 000311  3364          DCA SLOC        /STORE BUFFER ADDRESS FOR XFER
 186 000312  2360          ISZ SDENT       /LOOK AT STARTING BLOCK NUMBER
 187 000313  1760          TAD I SDENT     /GET STARTING BLOCK NUMBER
 188 000314  4205          JMS SNDNUM      /TELL SERVER STARTING BLOCK NUMBER
 189 000315  2360          ISZ SDENT       /LOOK AT ERROR RETURN
 190 000316  4215          JMS GETNUM      /RECEIVE CDF INSTRUCTION
 191 000317  3320          DCA .+1         /FOR TRANSFER
 192 000320  7402          HLT             /AND SET UP THE TRANSFER FIELD
 193 000321  4215          JMS GETNUM      /RECEIVE NEGATIVE WORD COUNT
 194 000322  3365          DCA WORDCT
 195 000323  4215  GETACK, JMS GETNUM      /4000=READ, 4001=WRITE, 0000=DONE, 2000=ERROR
 196 000324  7450          SNA             /WAS IT ZERO?
 197 000325  5351          JMP EXIT        /YES, EXIT
 198 000326  7104          CLL RAL         /NO, IS HIGH BIT SET?
 199 000327  7420          SNL
 200 000330  5355          JMP DSKERR       /NO, ERROR!
 201 000331  7640          SZA CLA         /YES, READ OR WRITE?
 202 000332  5342          JMP TXLP        /TIME TO WRITE
 203               
 204                                       /READ ROUTINE
 205 000333  4215  RXLP,   JMS GETNUM      /GET WORD
 206 000334  3764          DCA I SLOC      /STORE CONTENTS
 207 000335  2364          ISZ SLOC        /NEXT LOCATION
 208 000336  4231          JMS CTRLC       /CHECK FOR ^C (A SKIP WOULDN'T MATTER)
 209 000337  2365          ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 210 000340  5333          JMP RXLP        /NO, KEEP LOOPING
 211 000341  5323          JMP GETACK      /CHECK FINAL ACKNOWLEDGEMENT
 212               
 213                                       /WRITE ROUTINE
 214 000342  1764  TXLP,   TAD I SLOC      /GET WORD
 215 000343  2364          ISZ SLOC        /NEXT LOCATION
 216 000344  7000          NOP             /CAN'T ABORT HERE - SERVER WOULD HANG
 217 000345  4205          JMS SNDNUM      /SEND IT
 218 000346  2365          ISZ WORDCT      /INCREMENT WORD COUNT...DONE?
 219 000347  5342          JMP TXLP        /NO, KEEP LOOPING
 220 000350  5323          JMP GETACK      /CHECK FINAL ACKNOWLEDGEMENT
 221               
 222 000351  2360  EXIT,   ISZ SDENT       /POINT TO NORMAL EXIT
 223 000352  4231          JMS CTRLC       /LAST CHECK FOR INTERRUPT
 224 000353  7402  SFIELD, HLT             /MODIFIED TO CDI
 225 000354  5760          JMP I SDENT     /EXIT TO APPROPRIATE ADDRESS
 226 000355  7130  DSKERR,  CLL CML RAR     /ROTATE ERROR CODE AND SET NEGATIVE BIT
 227 000356  5353          JMP SFIELD      /ERROR EXIT
 228               
 229 000357  0000  SDCNT,  0               /TRACKER FOR ENTRY POINT NUMBER
 230 000360  0000  SDENT,  0               /SURROGATE FOR ENTRY POINT
 231 000361  2357  SDISZ,  ISZ SDCNT       /TO RESTORE ENTRY POINT
 232 000362  0177  S177,   177
 233 000363  7775  M3,     -3              /MINUS OF ^C 7-BIT CHARACTER
 234 000364  0000  SLOC,   0
 235 000365  0000  WORDCT, 0
 236               $$$$$$

BASER   6400
BASET   6410
BLKNUM  6260 unreferenced
CTRLC   0231
DSKERR  0355
EXIT    0351
GETACK  0323
GETNUM  0215
M3      0363
RXLP    0333
S177    0362
S7600   0232
SCDI    0242
SDA0    0253
SDA1    0251
SDA2    0247
SDA3    0245
SDB0    0252
SDB1    0250
SDB2    0246
SDB3    0244
SDCNT   0357
SDENT   0360
SDGET   0271
SDISZ   0361
SDTAD   0276
SENDC   0200
SFIELD  0353
SKCC    6402
SKCF    6400 unreferenced
SKIE    6405
SKRB    6406
SKRS    6404
SKSF    6401
SLOC    0364
SNDNUM  0205
SRESTR  0274
STCF    6412 unreferenced
STFL    6410 unreferenced
STLS    6416
STPC    6414 unreferenced
STSF    6411
STSK    6415 unreferenced
TXLP    0342
VERS    0006
WKUP    0254
WORDCT  0365
